#Comparator Data Set Analyses#Original File "comparatorsites_nov23_16.xlsx"#File covers Q4 of 2011 and is complete through Q3 of 2016 OR 20 total Quarters
#clear memoryrm(list=ls())
#Set Working Directory
setwd("//vhapalmpncptsd1/shared research/R/comparator")
#Check Working Directorygetwd()
#Libraries
library(Hmisc)library(survival)library(latticeExtra)library(gridExtra)library(lme4)library(ICC)library(ICCbin)library(htmlTable)library(backports)library(psych)library(mnormt)
require(Hmisc)require(survival)require(latticeExtra)require(RColorBrewer)require(gridExtra)require(lme4)require(ICC)require(ICCbin)
#Read in Data
comparator.df <- read.csv("comparatorsites_nov23_16.csv",                           header = TRUE)
#Check Headers, Dimensions and Structure of the filehead(comparator.df)dim(comparator.df)str(comparator.df)
#Assign the Data Structure
comparator.df <- within(comparator.df, {  level <- factor(level, 0:1, c("sta3n","sta6a"))  stopcode <- factor(stopcode, 0:2, c("All Mental Health Stop Codes",                                      "PTSD", "SUD"))  quarter <- factor(quarter, 0:4, c("Q1","Q2","Q3","Q4",                                     "All Four Quarters"))  year <- factor(year, 0:5, c("2011", "2012", "2013",                               "2014", "2015", "2016"))  sta6a <- factor(sta6a, 0:1626)  divisionname <- factor(divisionName, 0:1072)  sta3n <- as.factor(sta3n)  sta6acomplexity <- factor(sta6aComplexity, 0:2,                             c("1", "2", "3"))  totalencounters <- as.numeric(totalEncounters)  telemental_health <- as.numeric(TMH)  patients <- as.numeric(patientPanel)  providers <- as.numeric(providerPanel)  psychiatrists <- as.numeric(psychiatrists)  psychologists <- as.numeric(psychologists)  socialworkers <- as.numeric(socialWorkers)  nurses <- as.numeric(nursePractitioners)  totalstopcodepairs <- as.numeric(totalStopCodePairs)  intake <- as.numeric(evalEncounter)  psychotherapy <- as.numeric(psychEncounter)  psychMM <- as.numeric(psychMMencounter)  group <- as.numeric(groupEncounter)  med_mgmt <- as.numeric(groupEncounter)  case_mgmt <- as.numeric(caseManagement)  phone_visit <- as.numeric(telephoneEncounter)  other <- as.numeric(otherEncounter)  dep_ebpsy_denom <- as.numeric(Depression_EBPsyEligible)  cbt_d_initial <- as.numeric(CBT_D_initial_appoints)  act_d_initial <- as.numeric(ACT_initial_appoints)  ipt_d_initial <- as.numeric(IPT_initial_appoints)  ptsd_ebpsy_denom <- as.numeric(PTSD_EBPsyEligible)  pe_initial <- as.numeric(PE_initial_appoints)  cpt_initial <- as.numeric(CPT_initial_appoints)  dep_ebpharm_denom <- as.numeric(Depression_EBPharmEligible)  dep_ebpharm_numer <- as.numeric(Depression_RX)  out_ebpharm_denom <- as.numeric(OUD_EBPharmEligible)  oud_ebpharm_numer <- as.numeric(OUD_RX)   aud_ebpharm_denom <- as.numeric(AUD_EBPharmEligible)  aud_ebpharm_numer <- as.numeric(AUD_RX)})
# lowercase namesnames(comparator.df) <- tolower(names(comparator.df))
# describe datasummary(comparator.df)


#To select for a section of variables:
# select 1st and 5th thru 10th variables
newdata <- mydata[c(1,5:10)]
 
# based on variable values
newdata <- mydata[ which(mydata$gender=='F' 
                        & mydata$age > 65), ]
 
# or
attach(mydata)
newdata <- mydata[ which(gender=='F' & age > 65),]
detach(mydata)
 
 
#for selecting a random sample for ICC if you wanted to trythat:
# take a random sample of size 50 from a datasetmydata 
# sample without replacement
mysample <- mydata[sample(1:nrow(mydata), 50,
                         replace=FALSE),]
 
The subset( ) function is the easiest way to selectvariables and observations. In the following example, we select all rows thathave a value of age greater than or equal to 20 or age less then 10. We keepthe ID and Weight columns.
 
# using subset function 
newdata <- subset(mydata, age >= 20 | age <10, 
                 select=c(ID, Weight))
 
In the next example, we select all men over the age of 25and we keep variables weight through income (weight, income and all columnsbetween them).
 
# using subset function (part 2)
newdata <- subset(mydata, sex=="m" & age> 25,
                 select=weight:income)
 
 
#To take things from numeric to factor, two options:
#install varhandle package
unfactor(your_factor_variable)
 
https://stackoverflow.com/questions/3418128/how-to-convert-a-factor-to-an-integer-numeric-without-a-loss-of-information 
#clear memoryrm(list=ls())
#there does not appear to be a universally recommended option for reading Excel data without transformation.#each option has its drawbacks. In fact, most recommend actually just converting to .csv file since many subsequent commands function better that way (although you can definitely lose data in the transformation).#I'm including the read Excel commands in case you're interested
#possible dependencies you might need:##install.packages("devtools")##install.packages("Rcpp")
#install library to allow reading Excel data##library(readxl)
#set and read working file#specify sheet with a number or name#if NAs are represented by something other than blank cells, set NA argument##read_excel("comparatorsites_nov23_16.xlsx", sheet = 1, na = "NULL")-------------------------------------
#I am going to try the .csv moving forward though  #set working directory: I copied the data file into new folder called ICC in order to make sure that the original Excel file did not get corrupted
setwd('//vhapalmpncptsd1/Shared Research/TeamPSD/Model Code/ICC')
file="comparatorsites_nov23_16.csv"
data=read.csv(file,header=TRUE)
#if we want to clarify NULL code##data[data==NULL] <-NA ##data <- na.omit(data)
##LOOK UP na.rm
##omit Q5 or select for Q1-4 since Q5 is sum of Q1-4
what does data look like if we look at 6 years of Q5.  vrs. 24 observations of 6 years of Q 1 - Q4

# lowercase namesnames(data) <- tolower(names(data))
#attach data so that each variable doesn't have to be defined each time you use it
attach(data)

#run data code to check if you are reading the correct file
summary(data)
#to calculate reach for each disorder#Depression EBPsy Reach
depression_psy_reach <- ((cbt_d_initial_appoints + act_initial_appoints + ipt_initial_appoints)/depression_ebpsyeligible)
#PTSD EBPsy Reach
ptsd_psy_reach <- ((pe_initial_appoints) + cpt_initial_appoints)/ptsd_ebpsyeligible
#DepressionC EBPharm Reach
depression_pharm_reach <- depression_rx/depression_ebpharmeligible
#OUD EBPharm Reach
oud_pharm_reach <- oud_rx/oud_ebpharmeligible
#install ICC package#information about ICC package: https://cran.r-project.org/web/packages/ICC/ICC.pdfinstall.packages("ICC")
#starting with ICC for site. ICC = ratio of variance between sites / total varianceICCbareF(x, y, data)

